# 蓄水池抽样

**问题描述**：给定一个未知的数据流 $[a_1, a_2, \ldots, a_n]$，在只遍历一遍数据的情况下，抽取m个不同的数，要求均匀采样。这里的不同，指的是数据流的位置不同，而不是值不同。

**分析**：这道题的难点就是在不知道数据长度的情况下，完成均匀采样。

## 抽一个样本
先研究 $m = 1$ 的情况，每增加一个数，我们需要修正概率：

\begin{cases}
    n=1: & 1 \\
    n=2: & 1 \times \frac{1}{2} & \frac{1}{2} \\
    n=3: & \frac{1}{2} \times \frac{2}{3} & \frac{1}{2} \times \frac{2}{3} & \frac{1}{3} \\
    \vdots
\end{cases}

假设，我们已经从 $[a_1, \ldots, a_{n-1}]$ 的序列中均匀采样一个数 $b$。 现在读到了第 $n$ 个数 $a_{n}$, 那么我们以 $\frac{1}{n}$ 的概率选择新的数 $a_{n}$, 再以 $\frac{n-1}{n}$ 的概率选 $b$。这样，我们就完成了 $n$ 个数的均匀采样。
这种叠加的选择操作，能够改变概率，是这个算法的核心。

## 抽m个不同的样本

我们先研究 $m=2$ 的情况：

\begin{cases}
    n=2: & 1 & 1\\
    n=3: & 1 \times \frac{2}{3} & 1 \times \frac{2}{3} & \frac{2}{3} \\
    n=4: & \frac{2}{3} \times \frac{3}{4} & \frac{2}{3} \times \frac{3}{4} &\frac{2}{3} \times \frac{3}{4} & \frac{2}{4} \\
    \vdots
\end{cases}

类似的，我们假设已经从 $[a_1, a_2, \ldots, a_{n-1}]$ 的序列中均匀采集了 $m$ 个数 $[b_1, b_2, \ldots, b_m]$。现在我们读到了第 $n$ 个数 $a_{n}$，我们首先决定 $a_{n}$ 是否要出现在采样样本中，保证出现的概率为 $m / n$。如果要替换，那么我们从 $[b_1, b_2, \ldots, b_m]$ 均匀选择一个数被 $a_{n}$ 替换。

## 分布式蓄水池抽样

**问题描述**：现在又 $K$ 台服务器，每台服务器已经处理的数据量分别为 $N_1, N_2, \ldots, N_K$。需要总体样本中采集 $m$ 个不同的数。

**分析**：我们肯定要先让各个服务器各自采集 $m$ 个不同的数，那么关键还是要通过选择，来把概率修正回来。先分析已经采集到的数据的概率：

\begin{cases}
    site1: &\frac{m}{N_1}, &\frac{m}{N_1}, &\ldots, &\frac{m}{N_1} \\
    site2: &\frac{m}{N_2}, &\frac{m}{N_2}, &\ldots, &\frac{m}{N_2} \\
    \vdots \\
    siteK: &\frac{m}{N_K}, &\frac{m}{N_K}, &\ldots, &\frac{m}{N_K} \\
\end{cases}

定义 $N = \sum^K_{i=1} N_i$，那么我们的目标是每个样本出现的概率是 $\frac{m}{N}$。
有点重要性采样的意味: 我们以 $\frac{N_i}{N}$ 的概率选择集合 $site_i$，然后从 $site_i$ 不放回地均匀采样一个值放入最终的结果中。
